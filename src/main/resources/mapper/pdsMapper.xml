<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.board.pds.mapper.PdsMapper">  
 
  <!-- 자료실 목록 조회  --> 
  <select id="getPdsList" >
  	 SELECT  BNO
	       , TITLE
	       , WRITER
	       -- 상관 서브 쿼리 (corelative subquery)
	       , ( SELECT  COUNT(*) 
               FROM   FILES  F
               WHERE  B.BNO = F.BNO ) FILESCOUNT
	       , TO_CHAR(REGDATE, 'YYYY-MM-DD' )  REGDATE 
	       , HIT
       FROM   BOARD  B
       WHERE  MENU_ID = #{ menu_id  }
       ORDER  BY BNO DESC
  
  </select>
  
  <!-- getPds  -->
  <select id="getPds">
  
    SELECT    BNO
            , MENU_ID
            , TITLE
            , CONTENT
            , WRITER
            , TO_CHAR(REGDATE, 'YYYY-MM-DD HH24:MI:SS')  REGDATE            
     FROM    BOARD
     WHERE   BNO  = #{ bno }   
  
  </select>
  
  <select id="getFileList">:
  
   SELECT     FILE_NUM
			  ,BNO
			  ,FILENAME
			  ,FILEEXT
			  ,SFILENAME
	FROM      FILES		  
    WHERE     BNO = #{ bno }
  
  </select>
  
  <!--  자료시 글 쓰기(Board table) -->
  <insert id="setWrite">
  	INSERT INTO BOARD (
  		BNO,
  		MENU_ID,
  		TITLE,
  		CONTENT,
  		WRITER,
  		REGDATE,
  		HIT
  	)
  	VALUES(
  		(SELECT NVL(MAX(BNO),0)+1 FROM BOARD),
  		#{menu_id},
  		#{title},
  		#{content},
  		#{writer},
  		sysdate,
  		0
  	)
  
  
  </insert>
  <!--  자료시 파일정보 저장(FIles table) -->
  <!--  FileInsert : 넘어온 파일 여러개를 한번에 저장 insert all -->
  <!--  ORACLE INSERT ALL 반복할 때  
  		1)SELECT NVL(MAX(file_num),0)+1, 
  		2)시퀀스는 한번만 실행되기 때문에
  		INSERT ALL 에 바로 집어 넣을 수 없다
  		별도의 ORACLE 함수를 생성하여 호출 해야 값을 증가 할 수 있다
  		
  		mybatis <insert> 안에는 ; 을 사용할수 없다
  		- insert value ; 를 여러번 사용할 수 없다 (이유 ; 때문에)
  		insert all 사용하면 insert 여러번 가능한데 이경우 
  		select (max()) , 시퀀스는 여러번 적어도 한번만 호출되므로
  		insert value 의 값이 증가 되지 않는다
  		=> oracle에 별도 함수에 저장하여 반복 호출하면 된다
  		 -->
  <insert id="setFileWrite">
  	<foreach item="file" collection="fileList" 
  	index="i" 
  	open="INSERT ALL"
  	close="SELECT * FROM DUAL" 
  	separator=" ">
  	INTO FILES VALUES(
  		GET_FILENUM(),
  		(SELECT MAX(BNO) FROM BOARD),
  		#{file.filename},
  		#{file.fileext},
  		#{file.sfilename}
  		)
  		
  		
  	
  	</foreach>
  	
  
  </insert>


<select id="getPdsList">
	SELECT 
	    BNO,
	    TITLE,
	    WRITER,
	    TO_CHAR(REGDATE, 'YYYY"년 "MM"월 "DD"일') AS REGDATE,
	    HIT,
	    (SELECT COUNT(*)FROM FILES F WHERE  B.BNO=F.BNO ) FILESCOUNT
	    
	FROM   BOARD B
	WHERE  MENU_ID = 'MENU01'
	ORDER BY BNO DESC
</select>	 

<select id="getPds">
	SELECT 
	    BNO,
	    MENU_ID,
	    TITLE,
	    CONTENT,
	    WRITER,
	    TO_CHAR(REGDATE, 'YY"년 "MM"년 "DD"일') AS REGDATE
	    
	FROM  BOARD
	WHERE BNO = #{bno}

</select>

<select id="getFileList">
	SELECT 
		FILE_NUM,
		FILENAME,
		FILEEXT,
		SFILENAME
	FROM FILES
	WHERE BNO = #{bno}	


</select>
	
</mapper>

















